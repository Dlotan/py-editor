<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>Py Editor</title>
  <meta http-equiv="X-UA-Compatible" content="IE=9">

  <!-- Load the Realtime libraries. -->
  <script type="text/javascript"
          src="https://apis.google.com/js/api.js"></script>

  <!-- Load the utility library. -->
  <script type="text/javascript"
          src="/static/js/realtime-client-utils.js"></script>
  <link rel="stylesheet" href="/static/css/codemirror.css">
  <link rel="stylesheet" href="/static/css/index.css">
  <script src="/static/js/codemirror.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript"></script> 
<script src="/static/js/skulpt.min.js" type="text/javascript"></script> 
<script src="/static/js/skulpt-stdlib.js" type="text/javascript"></script> 
<script type="text/javascript" 
        src="/static/js/python.js"></script>

<script src="/polymer/platform/platform.js"></script>

<link rel="import" href="/polymer/core-icon-button/core-icon-button.html">
<link rel="import" href="/polymer/core-toolbar/core-toolbar.html">
<link rel="import" href="/polymer/core-header-panel/core-header-panel.html">
<link rel="import" href="/polymer/paper-button/paper-button.html">
<link rel="import" href="/polymer/core-splitter/core-splitter.html">

</head>

  <!-- Start Realtime when the body has loaded. -->
 <body onLoad='startRealtime()'>
 
 <core-header-panel mode="standard" id="core_header_panel">
  <core-toolbar id="core_toolbar">
    <paper-button id="authorizeButton" class="colored" raisedButton label="You must authorize"></paper-button>
    <core-icon-button id="shareButton" icon="reply" disabled>Share</core-icon-button>
    <core-icon-button id="undoButton" icon="rotate-left" disabled>Undo</core-icon-button>
    <core-icon-button id="redoButton" icon="rotate-right" disabled>Redo</core-icon-button>
    <core-icon-button id="runButton" icon="send" disabled>Run</core-icon-button>
    <div id="div"></div>
  </core-toolbar>
  <section id="section">
  <img class="loader-gif" id="loader-gif" src="/static/html/ajax-loader.gif" style="display: none;">
  <div horizontal layout id="editor-hide" style="visibility: hidden;">
  <div style="width:50%;height:100%">
   <!-- Text areas that will be used as our collaborative controls. -->
   <textarea id="editor"></textarea>
  </div>
  <core-splitter direction="left"></core-splitter>
  <div flex>
    <pre id="output"></pre> 
    <!-- If you want turtle graphics include a canvas -->
    <canvas id="mycanvas" ></mycanvas> 
  </div>
  </div>
  </section>
  asddsa
</core-header-panel>

  <script>
  
    /**
     * This function is called the first time that the Realtime model is created
     * for a file. This function should be used to initialize any values of the
     * model. In this case, we just create the single string model that will be
     * used to control our text box. The string has a starting value of 'Hello
     * Realtime World!', and is named 'text'.
     * @param model {gapi.drive.realtime.Model} the Realtime root model object.
     */
    function initializeModel(model) {
      var string = model.createString('print "hello world"');
      model.getRoot().set('code', string);
    }
     
    function outf(text) { 
      var mypre = document.getElementById("output"); 
      mypre.innerHTML = mypre.innerHTML + text; 
    } 
    function builtinRead(x) {
      if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
              throw "File not found: '" + x + "'";
      return Sk.builtinFiles["files"][x];
    }
    
    var myCodeMirror = null;
    
    function runit() { 
      var prog = myCodeMirror.getValue(); 
      var mypre = document.getElementById("output"); 
      mypre.innerHTML = ''; 
      Sk.canvas = "mycanvas";
      Sk.pre = "output";
      Sk.configure({output:outf, read:builtinRead}); 
      try {
         eval(Sk.importMainWithBody("<stdin>",false,prog)); 
      }
      catch(e) {
          alert(e.toString())
      }
    }

    /**
     * This function is called when the Realtime file has been loaded. It should
     * be used to initialize any user interface components and event handlers
     * depending on the Realtime model. In this case, create a text control binder
     * and bind it to our string model that we created in initializeModel.
     * @param doc {gapi.drive.realtime.Document} the Realtime document.
     */
    function onFileLoaded(doc) {
      var string = doc.getModel().getRoot().get('code');

      // Keeping one box updated with a String binder.
      var textArea = document.getElementById('editor');
      gapi.drive.realtime.databinding.bindString(string, textArea);
      
      // Codemirror
      myCodeMirror = CodeMirror.fromTextArea(textArea, {
        value: string.getText(),
        mode: {name: "python",
	        version: 2,
	        singleLineStringErrors: false},
	      lineNumbers: true,
	      indentUnit: 4,
	      tabMode: "shift",
	      matchBrackets: true
      });
      myCodeMirror.on("change", function() {
        string.setText(myCodeMirror.getValue());
      });
      
      var runButton = document.getElementById('runButton');
      runButton.onclick = function(e) {
        runit();  
      };
      runButton.removeAttribute('disabled')
      
      var shareButton = document.getElementById('shareButton');
      shareButton.onclick = function(e) {
        prompt("Give this link to the other person", document.URL);
      };
      shareButton.removeAttribute('disabled')
      
      var updateTextArea = function(e) {
        var cursor = myCodeMirror.getCursor();
        myCodeMirror.setValue(string.getText());
        myCodeMirror.setCursor(cursor);
      };
      string.addEventListener(gapi.drive.realtime.EventType.TEXT_INSERTED, updateTextArea);
      string.addEventListener(gapi.drive.realtime.EventType.TEXT_DELETED, updateTextArea);

      // Add logic for undo button.
      var model = doc.getModel();
      var undoButton = document.getElementById('undoButton');
      var redoButton = document.getElementById('redoButton');
      undoButton.onclick = function(e) {
        model.undo();
      };
      redoButton.onclick = function(e) {
        model.redo();
      };

      // Add event handler for UndoRedoStateChanged events.
      var onUndoRedoStateChanged = function(e) {
        if (e.canUndo) {
          undoButton.removeAttribute('disabled');
        }
        else {
          undoButton.setAttribute("disabled", true);
        }
        if (e.canRedo) {
          redoButton.removeAttribute('disabled');
        }
        else {
          redoButton.setAttribute("disabled", true);
        }
        undoButton.disabled = !e.canUndo;
        redoButton.disabled = !e.canRedo;
      };
      model.addEventListener(gapi.drive.realtime.EventType.UNDO_REDO_STATE_CHANGED, onUndoRedoStateChanged);
      document.getElementById('loader-gif').style.display = "none";
      document.getElementById('editor-hide').style.visibility = "visible";
    }
     
    function afterAuthFunc() {
      document.getElementById('loader-gif').style.display = "block";
    }

    /**
     * Options for the Realtime loader.
     */
    var realtimeOptions = {
      /**
       * Client ID from the console.
       */
      clientId: '351900000929-isdo9c2d86thju282siblvgug7mm1egg.apps.googleusercontent.com',

      /**
       * The ID of the button to click to authorize. Must be a DOM element ID.
       */
      authButtonElementId: 'authorizeButton',

      /**
       * Function to be called when a Realtime model is first created.
       */
      initializeModel: initializeModel,

      /**
       * Autocreate files right after auth automatically.
       */
      autoCreate: true,

      /**
       * The name of newly created Drive files.
       */
      defaultTitle: "PyEditor-File",

      /**
       * The MIME type of newly created Drive Files. By default the application
       * specific MIME type will be used:
       *     application/vnd.google-apps.drive-sdk.
       */
      newFileMimeType: null, // Using default.

      /**
       * Function to be called every time a Realtime file is loaded.
       */
      onFileLoaded: onFileLoaded,

      /**
       * Function to be called to inityalize custom Collaborative Objects types.
       */
      registerTypes: null, // No action.

      /**
       * Function to be called after authorization and before loading files.
       */
      afterAuth: afterAuthFunc
    }

    /**
     * Start the Realtime loader with the options.
     */
    function startRealtime() {
      var realtimeLoader = new rtclient.RealtimeLoader(realtimeOptions);
      realtimeLoader.start();
    }

  </script>
</body>
</html>
